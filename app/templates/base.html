<!doctype html>
<html lang="ru" data-theme="auto">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>LertoWiki — внутренняя WIKI</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
<header class="topbar">
  <div class="brand"><a href="{{ url_for('index') }}">LertoWiki</a></div>
  <form class="search" method="get" action="{{ url_for('index') }}">
    <input type="search" name="q" placeholder="Поиск статей, модулей, чек-листов…" value="{{ request.args.get('q','') }}">
  </form>
  {% if current_user %}
  <div class="user">
    <span class="user-name">{{ current_user.first_name }} {{ current_user.last_name }}{% if current_user.is_admin %} · Admin{% endif %}</span>
    <a class="btn ghost" href="{{ url_for('logout') }}">Выйти</a>
  </div>
  {% endif %}
</header>

<main class="layout">
  <aside class="sidebar">
    <nav class="side-nav">
      <a href="{{ url_for('new_section') }}" class="btn primary full">+ Новый раздел</a>
      <a href="{{ url_for('about') }}" class="link block">О системе</a>
      <hr>
      <h4 class="side-title">Навигация</h4>
      <div class="tree">
        {% for s in nav_sections %}
        <details {% if request.path.startswith('/sections/' + s.id|string) or (s.subsections|length and s.subsections|map(attribute='id')|list|join(',') in request.path) %}open{% endif %} data-tree-node>
          <summary><a href="{{ url_for('section_detail', section_id=s.id) }}">{{ s.title }}</a></summary>
          {% if s.subsections %}
          <ul>
            {% for ss in s.subsections %}
              <li><a href="{{ url_for('subsection_detail', subsection_id=ss.id) }}">{{ ss.title }}</a></li>
            {% endfor %}
          </ul>
          {% endif %}
        </details>
        {% endfor %}
      </div>
    </nav>
  </aside>
  <section class="content">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flashes">
          {% for category, msg in messages %}
            <li class="flash {{ category }}">{{ msg }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    {% block breadcrumbs %}{% endblock %}
    {% block content %}{% endblock %}
  </section>
</main>

<footer class="footer">
  <span>&copy; {{ now.year }} LertoWiki</span>
</footer>

<script src="{{ url_for('static', filename='script.js') }}"></script>
<script>
document.addEventListener('click', function (e) {
  const btn = e.target.closest('.attachments-toggle');
  if (!btn) return;

  const panel = document.querySelector(btn.dataset.target);
  if (!panel) return;

  const expanded = btn.getAttribute('aria-expanded') === 'true';
  btn.setAttribute('aria-expanded', expanded ? 'false' : 'true');

  if (expanded) {
    panel.setAttribute('hidden', '');
  } else {
    panel.removeAttribute('hidden');
  }
});
</script>
</body>
</html>
